# ============================================================
# ðŸ’¬ WORKFLOW: Discord CI Alerts and Demo
# ============================================================
# â–¶ This workflow can perform two actions:
# 1ï¸âƒ£ Manually send a test message to Discord via the â€œRun workflowâ€ button.
# 2ï¸âƒ£ Automatically post an alert when another workflow fails.
# ============================================================

name: "Discord CI Alerts and Demo"

# ------------------------------------------------------------
# ðŸ“… WHEN should this workflow run?
# ------------------------------------------------------------
on:
  # 1ï¸âƒ£ Manual trigger via the "Run workflow" button.
  workflow_dispatch:
    inputs:
      mode: # -> Select which demo mode to trigger
        description: "Mode: test or fail or success"
        required: true
        default: "test"
      note: # -> Optional note displayed inside the Discord message
        description: "Optional note"
        required: false
        default: ""

  # 2ï¸âƒ£ Automatically triggered when these workflows have completed.
  workflow_run:
    workflows:
      - "Java Matrix Build"
      - "Simple Java CI"
      - "Python Matrix Build"
      - "Simple Python CI"
    types:
      - completed  # -> Fires when any of these workflows finish (success or failure).

# ------------------------------------------------------------
# âš™ï¸ JOBS â€” What this workflow does
# ------------------------------------------------------------
jobs:
  notify:
    runs-on: ubuntu-latest  # -> Executes on a GitHub-hosted Ubuntu runner.

    steps:
      # ======================================================
      # ðŸ§ª 1. MANUAL DEMO MESSAGES (Run workflow)
      # ======================================================

      # --- Neutral test message (blue embed) ---
      - name: Demo test message
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'test' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "â„¹ï¸ Webhook Test"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repository: `${{ github.repository }}`  \nRun: [Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 3447003  # blue

      # --- Failure-style demo (red embed) ---
      - name: Demo fail style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'fail' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "âŒ DEMO - CI failed"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repo: `${{ github.repository }}`  \nBranch: `${{ github.ref_name }}`  \nCommit: `${{ github.sha }}`  \n[Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 15548997  # red

      # --- Success-style demo (green embed) ---
      - name: Demo success style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "âœ… DEMO - CI success"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repo: `${{ github.repository }}`  \nBranch: `${{ github.ref_name }}`  \nCommit: `${{ github.sha }}`  \n[Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 5763719  # green

      # ======================================================
      # âš ï¸ 2. AUTOMATIC FAILURE ALERTS (workflow_run)
      # ======================================================
      - name: Auto alert on failure
        # -> Runs only if a monitored workflow did NOT succeed.
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "âŒ CI failed - ${{ github.event.workflow_run.name }}"
          embed-url: "${{ github.event.workflow_run.html_url }}"
          embed-description: "Repository: `${{ github.repository }}`  \nBranch: `${{ github.event.workflow_run.head_branch }}`  \nCommit: `${{ github.event.workflow_run.head_sha }}`  \n[Open Run](${{ github.event.workflow_run.html_url }})  \n> Please review the logs in the Actions run."
          embed-color: 15548997  # red
