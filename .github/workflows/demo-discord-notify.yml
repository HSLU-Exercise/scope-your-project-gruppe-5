name: "Discord CI Alerts and Demo"

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Mode: test or fail or success"
        required: true
        default: "test"
      note:
        description: "Optional note"
        required: false
        default: ""

  workflow_run:
    workflows:
      - "Java Matrix Build"
      - "Simple Java CI"
      - "Python Matrix Build"
      - "Simple Python CI"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Demo test message
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'test' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          content: "Webhook test (manual). Repo: ${{ github.repository }} Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} Note: ${{ github.event.inputs.note }}"

      - name: Demo fail style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'fail' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "DEMO - CI failed"
          embed-description: "Repo: ${{ github.repository }} Branch: ${{ github.ref_name }} Commit: ${{ github.sha }} Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} Note: ${{ github.event.inputs.note }}"
          embed-color: 15548997

      - name: Demo success style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "DEMO - CI success"
          embed-description: "Repo: ${{ github.repository }} Branch: ${{ github.ref_name }} Commit: ${{ github.sha }} Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} Note: ${{ github.event.inputs.note }}"
          embed-color: 5763719

      - name: Auto alert on failure
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "CI failed - ${{ github.event.workflow_run.name }}"
          embed-description: "Repo: ${{ github.repository }} Branch: ${{ github.event.workflow_run.head_branch }} Commit: ${{ github.event.workflow_run.head_sha }} Run: ${{ github.event.workflow_run.html_url }}"
          embed-color: 15548997
