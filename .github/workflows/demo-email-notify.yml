name: CI Email Alerts and Demo

on:
  workflow_dispatch:
    inputs:
      send_to:
        description: "Empfänger: me (nur ich) oder class (ganze Klasse)"
        required: true
        default: "me"
      note:
        description: "Optionaler Hinweis in der E-Mail"
        required: false
        default: ""
      force:
        description: "Auch ohne Fehler senden? (Demo)"
        type: boolean
        required: true
        default: true
  workflow_run:
    workflows:
      - "Java Matrix Build"
      - "Simple Java CI"
      - "Python Matrix Build"
      - "Simple Python CI"
    types: [completed]

jobs:
  demo_email:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug (workflow_dispatch Inputs)
        run: |
          echo "send_to=${{ github.event.inputs.send_to }}"
          echo "force=${{ github.event.inputs.force }} (string 'true'/'false')"

      - name: Empfänger festlegen (Demo)
        run: |
          if [ "${{ github.event.inputs.send_to }}" = "class" ]; then
            echo "RECIPIENTS=${{ vars.CLASS_EMAILS }}" >> $GITHUB_ENV
          else
            echo "RECIPIENTS=${{ vars.MY_EMAIL }}" >> $GITHUB_ENV
          fi

      - name: Test-Mail senden (Gmail über SMTP/SSL)
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.SMTP_SERVER }}   # smtp.gmail.com
          server_port: ${{ secrets.SMTP_PORT }}       # 465 (SSL)
          username: ${{ secrets.SMTP_USER }}          # hslu.ci.demo@gmail.com
          password: ${{ secrets.SMTP_PASS }}          # 16-stell. App-Passwort
          secure: true
          starttls: false
          from: ${{ secrets.SMTP_FROM }}              # = Gmail-User
          to: ${{ env.RECIPIENTS }}
          subject: "✅ Demo-Mail von ${{ github.repository }}"
          body: |
            DEMO-E-Mail aus GitHub Actions.

            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Manuell gestartet von: ${{ github.actor }}
            Hinweis: ${{ github.event.inputs.note }}

            Aktueller Run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify_on_failure:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug (workflow_run Kontext)
        run: |
          echo "Triggered by workflow:  ${{ github.event.workflow_run.name }}"
          echo "Conclusion:            ${{ github.event.workflow_run.conclusion }}"
          echo "Branch:                ${{ github.event.workflow_run.head_branch }}"
          echo "HTML URL:              ${{ github.event.workflow_run.html_url }}"

      - name: Empfänger festlegen (zuerst nur du)
        run: echo "RECIPIENTS=${{ vars.MY_EMAIL }}" >> $GITHUB_ENV
    

      - name: Fehlermail senden (Gmail über SMTP/SSL)
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          secure: true
          starttls: false
          from: ${{ secrets.SMTP_FROM }}
          to: ${{ env.RECIPIENTS }}
          subject: "❌ CI-Fehler in ${{ github.event.workflow_run.name }} @ ${{ github.repository }}"
          body: |
            Ein CI-Workflow ist fehlgeschlagen.

            Repository: ${{ github.repository }}
            Workflow:  ${{ github.event.workflow_run.name }}
            Branch:    ${{ github.event.workflow_run.head_branch }}
            Commit:    ${{ github.event.workflow_run.head_sha }}
            Auslöser:  ${{ github.event.workflow_run.actor.login }}

            Logs & Details:
            ${{ github.event.workflow_run.html_url }}

            Hinweis:
            Empfänger-Liste: Repo → Settings → Actions → Variables (MY_EMAIL / CLASS_EMAILS)
