# ============================================================
# üí¨ WORKFLOW: Discord CI Alerts and Demo
# ============================================================
# ‚ñ∂ Dieser Workflow kann zwei Dinge:
# 1Ô∏è‚É£ Manuell (per Knopfdruck) eine Testnachricht an Discord senden.
# 2Ô∏è‚É£ Automatisch eine Fehlermeldung posten, wenn ein anderer Workflow fehlschl√§gt.
# ============================================================

name: "Discord CI Alerts and Demo"

# ------------------------------------------------------------
# üìÖ WANN soll der Workflow starten?
# ------------------------------------------------------------
on:
  # 1Ô∏è‚É£ Manueller Start √ºber den "Run workflow"-Knopf.
  workflow_dispatch:
    inputs:
      mode: # -> W√§hle, welche Demo du starten willst
        description: "Mode: test or fail or success"
        required: true
        default: "test"
      note: # -> Optionaler Kommentartext, wird in Discord angezeigt
        description: "Optional note"
        required: false
        default: ""

  # 2Ô∏è‚É£ Automatischer Start, wenn diese Workflows abgeschlossen sind.
  workflow_run:
    workflows:
      - "Java Matrix Build"
      - "Simple Java CI"
      - "Python Matrix Build"
      - "Simple Python CI"
    types:
      - completed  # -> L√∂st aus, wenn einer dieser Workflows fertig ist (egal ob erfolgreich oder fehlerhaft).

# ------------------------------------------------------------
# ‚öôÔ∏è JOBS - Was der Workflow tut
# ------------------------------------------------------------
jobs:
  notify:
    runs-on: ubuntu-latest  # -> F√ºhrt die Schritte auf einer Ubuntu-Maschine in der Cloud aus.

    steps:
      # ======================================================
      # üß™ 1. MANUELLE DEMO-NACHRICHTEN (Knopfdruck)
      # ======================================================

      # --- Testnachricht (neutral) ---
      - name: Demo test message
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'test' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "‚ÑπÔ∏è Webhook Test"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repository: `${{ github.repository }}`  \nRun: [Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 3447003  # blau

      # --- Fehler-Demo (rote Meldung) ---
      - name: Demo fail style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'fail' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "‚ùå DEMO - CI failed"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repo: `${{ github.repository }}`  \nBranch: `${{ github.ref_name }}`  \nCommit: `${{ github.sha }}`  \n[Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 15548997  # rot

      # --- Erfolgs-Demo (gr√ºne Meldung) ---
      - name: Demo success style
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "‚úÖ DEMO - CI success"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: "Repo: `${{ github.repository }}`  \nBranch: `${{ github.ref_name }}`  \nCommit: `${{ github.sha }}`  \n[Open Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  \nNote: `${{ github.event.inputs.note }}`"
          embed-color: 5763719  # gr√ºn

      # ======================================================
      # ‚ö†Ô∏è 2. AUTOMATISCHER FEHLER-ALARM (workflow_run)
      # ======================================================
      - name: Auto alert on failure
        # -> Wird nur ausgef√ºhrt, wenn ein √ºberwachter Workflow fehlschl√§gt.
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "CI Notifier"
          embed-title: "‚ùå CI failed - ${{ github.event.workflow_run.name }}"
          embed-url: "${{ github.event.workflow_run.html_url }}"
          embed-description: "Repository: `${{ github.repository }}`  \nBranch: `${{ github.event.workflow_run.head_branch }}`  \nCommit: `${{ github.event.workflow_run.head_sha }}`  \n[Open Run](${{ github.event.workflow_run.html_url }})  \n> Bitte pr√ºfe die Logs im Actions-Run."
          embed-color: 15548997  # rot
